---
title: "Internet Explorer: A Failure as a Browser, A Success as a Malware Analysis Tool"
date: 2024-09-02 10:00:00
classes: wide
header:
  teaser: /assets/images/Internet-Explorer-A-Failure-as-a-Browser-A-Success-as-a-Malware-Analysis-Tool/logo.png
  overlay_image: /assets/images/Internet-Explorer-A-Failure-as-a-Browser-A-Success-as-a-Malware-Analysis-Tool/logo.png
  overlay_filter: 0.5
ribbon: DarkSlateGray
excerpt: "Advanced JavaScript deobfuscation of an exploit kit using Internet Explorer"
description: "Advanced JavaScript deobfuscation of an exploit kit using Internet Explorer"
categories:
  - Malware
tags:
  - JS
  - Exploit kit
  - Windows
  - Ransomware
  - JS deobfuscation
  - Network traffic analysis
  - Web session analysis 
toc: true
toc_sticky: true
toc_label: "On This Blog"
toc_icon: "biohazard"
---
# Introduction

In this post, we will examine a malware infection delivered through a browser attack that implements an `Obfuscated JavaScript Exploit Kit` leading to the execution of `Ransomware`.
 
This is an excellent opportunity to explore various tactics, techniques and tools used to analyze such infections, helping you assess the potential impact of a similar attack on your organization.

To achive this, we will use the following tools: `Fiddler` as a web proxy, `Wireshark` to monitor network traffic and `Notepad++` alongside `Internet Explorer` to **deobfuscate the malicious JavaScript**... Yes, you read that right, `IE` as a **malware analysis tool**.

# Sample Details

|      Web Session Traffic          |                          |
|----------------|-------------------------------|
|File Name           |`Web-Session.saz`            |
|File Size           |`3085836 bytes`            |
|MD5          |`104bb64a9c4f6abbed67c0cc772744c6`|
|SHA256          |`26a1f2534305704194b50a71e38660e1794b84708cacf9f4622e30a4605f4661`|

-------------------------------

|      Network Traffic          |                          |
|----------------|-------------------------------|
|File Name           |`Web-Session.pcap`            |
|File Size           |`2574472 bytes`            |
|MD5          |`1b8c62edd6577c0a87333eddb4faa728`|
|SHA256          |`cd4cb335a14abd173255002ca6be60dadc8b2b82ab68832eff61b49f0390312b`|

-------------------------------

|      Exploit-Kit          |                          |
|----------------|-------------------------------|
|File Name           |`Exploit-kit.html`            |
|File Size           |`3533 bytes`            |
|MD5          |`6591755acbd7422e7d693ddc2a793442`|
|SHA256          |`27fb731a21cf1a7811aaeb06988742ae26651f17ecfee9b227f117209524ce01`|


# Web Traffic Analysis

After capturing the web session with `Fiddler` and navigating to the suspicious website, we can begin investigating its  requests and responses. 

In the first `200` response of `www.hiltongardeninnoakville.com`,  at the end of the response, there is a `<script>` tag where the variable `wcvius` is defined, which directly points to the URL where the malicious code is stored.

In additional, we can observe that the variable `bnryty` contains `document.createElement("iframe");`. This code is used to create a hidden iframe within the infected page.

Furthermore, the line `document.body.appendChild(bnryty)` adds the iframe element to the rest of the webpage.

At the same time, the elemnt `bnryty.src =  wcvius;` load the malicious URL inside the iframe. 

![Untitled](/assets/images/Internet-Explorer-A-Failure-as-a-Browser-A-Success-as-a-Malware-Analysis-Tool/2.png "Fig1: Fiddler - First respone of www.hiltongardeninnoakville.com")

Once the malicious site `http://my.georgethorpebourbon.com/...` is loaded, we can see the obfuscated JavaScript code in its response. However for now, let's continue reviewing the web session traffic.

![Untitled](/assets/images/Internet-Explorer-A-Failure-as-a-Browser-A-Success-as-a-Malware-Analysis-Tool/3.png "Fig2: Fiddler - Obfuscated JavaScript")

In the second response from `http://my.georgethorpebourbon.com/...` we can see a malicious Adobe Flash file. This can be identified by its magic bytes, `43 57 53 - CWS`

![Untitled](/assets/images/Internet-Explorer-A-Failure-as-a-Browser-A-Success-as-a-Malware-Analysis-Tool/4.png "Fig3: Fiddler - Malicious Adobe Flash File")

At the end of the web session traffic, we can notice two request to  `195.154.122.33/default.jpg`. However, upon reviewing the response, we can see that it is not an image; instead it is a string: `default`

![Untitled](/assets/images/Internet-Explorer-A-Failure-as-a-Browser-A-Success-as-a-Malware-Analysis-Tool/5.png "Fig4: Fiddler - Response from 195.154.122/default.jpg")

# Network Traffic

In order to obtain more context about `195.154.122.33`, we can examine the network traffic generated during the malware detonation. To do this, we can apply the following filter in Wireshark. `ip.addr == 195.154.122.33`, which allows us to analyze only the traffic we are interested in. 

After applying the filter, we can see that Wireshark intercepted a `POST request` to `/setting/get_setting.php` that Fiddler was unable to catch. **This highlights the importance of using at least two tools for the same propuse during an investigation.**

This `POST request` contains data related to a parameter named `key`, which may indicate the use of a **key exchange protocol**. Additionally, the `ind` parameter could represent the unique identifier of the infected system, potentially required by the victim to decrypt their files.

![Untitled](/assets/images/Internet-Explorer-A-Failure-as-a-Browser-A-Success-as-a-Malware-Analysis-Tool/6.png "Fig5: Wireshark - key & ind parameter")

# JS Exploit Kit Deobfuscation 

